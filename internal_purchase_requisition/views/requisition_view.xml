<odoo>
    <data>
        <!--purchase order form inherit reference number-->
        <record id="view_purchase_order_form_inherit_requisition" model="ir.ui.view">
            <field name="name">purchase.order.form.inherit.requisition</field>
            <field name="model">purchase.order</field>
            <field name="inherit_id" ref="purchase.purchase_order_form"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='partner_id']" position="attributes">
                    <attribute name="domain">[('verified_partner', '=', True)]</attribute>
                </xpath>
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="requisition_ids" widget="many2many_tags" options="{'no_create': True}"
                           placeholder="Requisition Reference"/>
                </xpath>
            </field>
        </record>

        <record id="view_purchase_requisition_tree" model="ir.ui.view">
            <field name="name">purchase.requisition.tree</field>
            <field name="model">int_purchase.requisition</field>
            <field name="arch" type="xml">
                <list>
                    <header>
                        <button name="create_purchase_order_from_requisition" type="object"
                                string="Create PO" class="btn-primary"/>
                    </header>
                    <field name="name"/>
                    <field name="department_id" optional="show"/>
                    <field name="requested_by"/>
                    <field name="date"/>
                    <field name="approval_status" string="PR Status" widget="badge"
                           decoration-info="approval_status == 'draft'"
                           decoration-warning="approval_status == 'cancel'"
                           decoration-primary="approval_status == 'submitted'"
                           decoration-success="approval_status in ['approved','procurement_officer_approved']"
                           decoration-danger="approval_status == 'rejected'"
                           decoration-muted="approval_status == 'closed'" optional="show"/>
                    <field name="approval_stage" string="Approval Status" optional="hide"/>
                    <field name="purchase_order_status" string="PO Status" widget="badge" optional="show"/>
                </list>
            </field>
        </record>

        <record id="view_purchase_requisition_form" model="ir.ui.view">
            <field name="name">purchase.requisition.form</field>
            <field name="model">int_purchase.requisition</field>
            <field name="arch" type="xml">
                <form string="Purchase Requisition">
                    <!-- Hide all mail fields to prevent auto-rendering -->
                    <field name="message_follower_ids" invisible="1"/>
                    <field name="activity_ids" invisible="1"/>
                    <field name="message_ids" invisible="1"/>

                    <header>
                        <button name="action_submit" string="Submit" type="object"
                                invisible="approval_status != 'draft'" class="oe_highlight"/>
                        <button name="action_approve_by_manager" string="Approve as Department Head" type="object"
                                invisible="(approval_status != 'procurement_officer_approved' or not is_manager)"
                                class="oe_highlight"/>
                        <button name="action_approve_by_procurement_officer" string="Approve as Procurement Officer"
                                type="object"
                                invisible="approval_status != 'submitted'" class="oe_highlight"/>
                        <button name="action_reject" string="Reject" type="object"
                                invisible="approval_status not in ['submitted', 'procurement_officer_approved']"/>
                        <button name="action_cancel" string="Cancel" type="object"
                                invisible="approval_status in ['cancel','closed','rejected']"/>
                        <button name="reset_draft" string="Reset to Draft" type="object"
                                invisible="approval_status not in ['cancel', 'rejected']"/>
                        <button name="action_create_purchase_order" string="Create Purchase Order" type="object"
                                invisible="approval_status != 'approved'"
                                groups="internal_purchase_requisition.group_procurement_officer"
                                class="oe_highlight"/>
                        <field name="approval_status" widget="statusbar"
                               statusbar_visible="draft,submitted,procurement_officer_approved,approved"/>
                    </header>

                    <sheet>
                        <!-- Smart buttons -->
                        <div class="oe_button_box">
                            <button name="action_view_purchase_orders"
                                    class="oe_stat_button"
                                    icon="fa-shopping-cart"
                                    type="object"
                                    invisible="purchase_order_count == 0">
                                <field name="purchase_order_count" widget="statinfo" string="Purchase Orders"/>
                            </button>
                        </div>

                        <!-- Invisible fields -->
                        <field name="is_manager" invisible="1"/>

                        <!-- Main form content -->
                        <group>
                            <group string="Requisition Information">
                                <field name="name" readonly="1"/>
                                <field name="department_id"/>
                                <field name="department_manager_id" readonly="1"/>
                                <field name="requested_by"/>
                            </group>
                            <group string="Dates &amp; Details">
                                <field name="date"/>
                                <field name="deadline_date"/>
                                <field name="subject"/>
                                <field name="cc_users" widget="many2many_tags"/>
                            </group>
                        </group>

                        <notebook>
                            <page name="requisition_line_ids" string="Requisition Lines">
                                <field name="requisition_line_ids" >
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="product_id"/>
                                        <field name="description"/>
                                        <field name="quantity"/>
                                        <field name="product_uom"/>
                                        <field name="price"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>

<!--                    <div class="oe_chatter">-->
<!--                        <field name="message_follower_ids"/>-->
<!--                        <field name="activity_ids"/>-->
<!--                        <field name="message_ids"/>-->
<!--                    </div>-->
                </form>
            </field>
        </record>

        <record id="action_purchase_requisition" model="ir.actions.act_window">
            <field name="name">Purchase Requisitions</field>
            <field name="res_model">int_purchase.requisition</field>
            <field name="view_mode">list,form</field>
            <field name="view_id" ref="view_purchase_requisition_tree"/>
        </record>

        <!-- Simplified Line Views - NO CHATTER -->
        <record id="view_purchase_requisition_line_tree" model="ir.ui.view">
            <field name="name">purchase.requisition.line.tree</field>
            <field name="model">int_purchase.requisition.line</field>
            <field name="arch" type="xml">
                <list>
                    <field name="sequence" widget="handle"/>
                    <field name="product_id"/>
                    <field name="description"/>
                    <field name="quantity"/>
                    <field name="product_uom"/>
                    <field name="price"/>
                </list>
            </field>
        </record>

        <record id="view_purchase_requisition_line_form" model="ir.ui.view">
            <field name="name">purchase.requisition.line.form</field>
            <field name="model">int_purchase.requisition.line</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <group>
                                <field name="product_id"/>
                                <field name="description"/>
                                <field name="quantity"/>
                            </group>
                            <group>
                                <field name="product_uom"/>
                                <field name="price"/>
                            </group>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="action_purchase_requisition_line" model="ir.actions.act_window">
            <field name="name">Purchase Requisitions Line</field>
            <field name="res_model">int_purchase.requisition.line</field>
            <field name="view_mode">list,form</field>
            <field name="view_id" ref="view_purchase_requisition_line_tree"/>
        </record>

        <menuitem id="purchase_requisition_menu_root" name="Purchase Requisitions" sequence="19"/>
        <menuitem id="menu_purchase_requisition" name="Purchase Requisitions"
                  parent="purchase_requisition_menu_root"
                  action="action_purchase_requisition"/>

    </data>
</odoo>